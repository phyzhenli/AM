clear;
clc;

bit = 8; % width of the multiplier
bitN = bit; % unsigned mul
% bitN = bit - 1; % signed mul

% LeNet
inputs = importdata("inputs_total.txt");
tab = tabulate(inputs(:));
pf = tab(:, 2)';
total_pf = numel(inputs);

weights = importdata("weights_total.txt");
tab = tabulate(weights(:));
l = tab(:, 1);
k = tab(:, 2);
pw = zeros(1, 2^bit);
for jdx = 1:max(size(l))
    pw(1,l(jdx,1)+1) = k(jdx,1); % unsigned mul
    % pw(1,l(jdx,1)+(2^bitN+1)) = k(jdx,1); % signed mul
end
total_pw = numel(weights);

nVars = 133; % the size of the matrix
n = zeros(nVars, 1);
a = zeros(nVars, nVars);
b = zeros(nVars, nVars);

% int32(-2^bitN):int32(2^bitN-1) signed mul
% 0:int32(2^bitN-1)              unsigned mul
for idx = 0:int32(2^bitN-1)
    for jdx = 0:int32(2^bitN-1)
        f = [];
        for cdx = 1:bit

            % unsigned mul
            part_pro = int32(jdx * bitget(idx, cdx));
            part_pro = bitget(part_pro, 1:1:bit);

            % signed mul
            % part_pro = int32(jdx * bitget(idx, cdx));
            % if cdx == bit
            %     part_pro = ~bitget(part_pro, 1:1:bit);
            %     part_pro(1, bit) = ~part_pro(1, bit);
            % else
            %     part_pro = bitget(part_pro, 1:1:bit);
            %     part_pro(1, bit) = ~part_pro(1, bit);
            % end

            f = [f part_pro];
        end
        % f = [f 1 1]; % signed mul
        f = int64(f);

        n(1,1) = int64( (idx * jdx) ) - f(1,49)*(2^6)-f(1,50)*(2^7)-f(1,51)*(2^8)-f(1,52)*(2^9)-f(1,53)*(2^10)-f(1,54)*(2^11)-f(1,55)*(2^12)-f(1,56)*(2^13)-f(1,57)*(2^7)-f(1,58)*(2^8)-f(1,59)*(2^9)-f(1,60)*(2^10)-f(1,61)*(2^11)-f(1,62)*(2^12)-f(1,63)*(2^13)-f(1,64)*(2^14);

        % generated by gencode
        n(2,1) = (-1)*f(1,1)*(2^0);
        n(3,1) = (-1)*(f(1,2)&f(1,9))*(2^1);
        n(4,1) = (-1)*(f(1,2)&f(1,9))*(2^2);
        n(5,1) = (-1)*(f(1,2)|f(1,9))*(2^1);
        n(6,1) = (-1)*(f(1,2)|f(1,9))*(2^2);
        n(7,1) = (-1)*(xor(f(1,2),f(1,9)))*(2^1);
        n(8,1) = (-1)*(xor(f(1,2),f(1,9)))*(2^2);
        n(9,1) = (-1)*(f(1,3)&f(1,10))*(2^2);
        n(10,1) = (-1)*(f(1,3)&f(1,10))*(2^3);
        n(11,1) = (-1)*(f(1,3)|f(1,10))*(2^2);
        n(12,1) = (-1)*(f(1,3)|f(1,10))*(2^3);
        n(13,1) = (-1)*(xor(f(1,3),f(1,10)))*(2^2);
        n(14,1) = (-1)*(xor(f(1,3),f(1,10)))*(2^3);
        n(15,1) = (-1)*(f(1,4)&f(1,11))*(2^3);
        n(16,1) = (-1)*(f(1,4)&f(1,11))*(2^4);
        n(17,1) = (-1)*(f(1,4)|f(1,11))*(2^3);
        n(18,1) = (-1)*(f(1,4)|f(1,11))*(2^4);
        n(19,1) = (-1)*(xor(f(1,4),f(1,11)))*(2^3);
        n(20,1) = (-1)*(xor(f(1,4),f(1,11)))*(2^4);
        n(21,1) = (-1)*(f(1,5)&f(1,12))*(2^4);
        n(22,1) = (-1)*(f(1,5)&f(1,12))*(2^5);
        n(23,1) = (-1)*(f(1,5)|f(1,12))*(2^4);
        n(24,1) = (-1)*(f(1,5)|f(1,12))*(2^5);
        n(25,1) = (-1)*(xor(f(1,5),f(1,12)))*(2^4);
        n(26,1) = (-1)*(xor(f(1,5),f(1,12)))*(2^5);
        n(27,1) = (-1)*(f(1,6)&f(1,13))*(2^5);
        n(28,1) = (-1)*(f(1,6)&f(1,13))*(2^6);
        n(29,1) = (-1)*(f(1,6)|f(1,13))*(2^5);
        n(30,1) = (-1)*(f(1,6)|f(1,13))*(2^6);
        n(31,1) = (-1)*(xor(f(1,6),f(1,13)))*(2^5);
        n(32,1) = (-1)*(xor(f(1,6),f(1,13)))*(2^6);
        n(33,1) = (-1)*(f(1,7)&f(1,14))*(2^6);
        n(34,1) = (-1)*(f(1,7)&f(1,14))*(2^7);
        n(35,1) = (-1)*(f(1,7)|f(1,14))*(2^6);
        n(36,1) = (-1)*(f(1,7)|f(1,14))*(2^7);
        n(37,1) = (-1)*(xor(f(1,7),f(1,14)))*(2^6);
        n(38,1) = (-1)*(xor(f(1,7),f(1,14)))*(2^7);
        n(39,1) = (-1)*(f(1,8)&f(1,15))*(2^7);
        n(40,1) = (-1)*(f(1,8)&f(1,15))*(2^8);
        n(41,1) = (-1)*(f(1,8)|f(1,15))*(2^7);
        n(42,1) = (-1)*(f(1,8)|f(1,15))*(2^8);
        n(43,1) = (-1)*(xor(f(1,8),f(1,15)))*(2^7);
        n(44,1) = (-1)*(xor(f(1,8),f(1,15)))*(2^8);
        n(45,1) = (-1)*f(1,16)*(2^8);
        n(46,1) = (-1)*f(1,17)*(2^2);
        n(47,1) = (-1)*(f(1,18)&f(1,25))*(2^3);
        n(48,1) = (-1)*(f(1,18)&f(1,25))*(2^4);
        n(49,1) = (-1)*(f(1,18)|f(1,25))*(2^3);
        n(50,1) = (-1)*(f(1,18)|f(1,25))*(2^4);
        n(51,1) = (-1)*(xor(f(1,18),f(1,25)))*(2^3);
        n(52,1) = (-1)*(xor(f(1,18),f(1,25)))*(2^4);
        n(53,1) = (-1)*(f(1,19)&f(1,26))*(2^4);
        n(54,1) = (-1)*(f(1,19)&f(1,26))*(2^5);
        n(55,1) = (-1)*(f(1,19)|f(1,26))*(2^4);
        n(56,1) = (-1)*(f(1,19)|f(1,26))*(2^5);
        n(57,1) = (-1)*(xor(f(1,19),f(1,26)))*(2^4);
        n(58,1) = (-1)*(xor(f(1,19),f(1,26)))*(2^5);
        n(59,1) = (-1)*(f(1,20)&f(1,27))*(2^5);
        n(60,1) = (-1)*(f(1,20)&f(1,27))*(2^6);
        n(61,1) = (-1)*(f(1,20)|f(1,27))*(2^5);
        n(62,1) = (-1)*(f(1,20)|f(1,27))*(2^6);
        n(63,1) = (-1)*(xor(f(1,20),f(1,27)))*(2^5);
        n(64,1) = (-1)*(xor(f(1,20),f(1,27)))*(2^6);
        n(65,1) = (-1)*(f(1,21)&f(1,28))*(2^6);
        n(66,1) = (-1)*(f(1,21)&f(1,28))*(2^7);
        n(67,1) = (-1)*(f(1,21)|f(1,28))*(2^6);
        n(68,1) = (-1)*(f(1,21)|f(1,28))*(2^7);
        n(69,1) = (-1)*(xor(f(1,21),f(1,28)))*(2^6);
        n(70,1) = (-1)*(xor(f(1,21),f(1,28)))*(2^7);
        n(71,1) = (-1)*(f(1,22)&f(1,29))*(2^7);
        n(72,1) = (-1)*(f(1,22)&f(1,29))*(2^8);
        n(73,1) = (-1)*(f(1,22)|f(1,29))*(2^7);
        n(74,1) = (-1)*(f(1,22)|f(1,29))*(2^8);
        n(75,1) = (-1)*(xor(f(1,22),f(1,29)))*(2^7);
        n(76,1) = (-1)*(xor(f(1,22),f(1,29)))*(2^8);
        n(77,1) = (-1)*(f(1,23)&f(1,30))*(2^8);
        n(78,1) = (-1)*(f(1,23)&f(1,30))*(2^9);
        n(79,1) = (-1)*(f(1,23)|f(1,30))*(2^8);
        n(80,1) = (-1)*(f(1,23)|f(1,30))*(2^9);
        n(81,1) = (-1)*(xor(f(1,23),f(1,30)))*(2^8);
        n(82,1) = (-1)*(xor(f(1,23),f(1,30)))*(2^9);
        n(83,1) = (-1)*(f(1,24)&f(1,31))*(2^9);
        n(84,1) = (-1)*(f(1,24)&f(1,31))*(2^10);
        n(85,1) = (-1)*(f(1,24)|f(1,31))*(2^9);
        n(86,1) = (-1)*(f(1,24)|f(1,31))*(2^10);
        n(87,1) = (-1)*(xor(f(1,24),f(1,31)))*(2^9);
        n(88,1) = (-1)*(xor(f(1,24),f(1,31)))*(2^10);
        n(89,1) = (-1)*f(1,32)*(2^10);
        n(90,1) = (-1)*f(1,33)*(2^4);
        n(91,1) = (-1)*(f(1,34)&f(1,41))*(2^5);
        n(92,1) = (-1)*(f(1,34)&f(1,41))*(2^6);
        n(93,1) = (-1)*(f(1,34)|f(1,41))*(2^5);
        n(94,1) = (-1)*(f(1,34)|f(1,41))*(2^6);
        n(95,1) = (-1)*(xor(f(1,34),f(1,41)))*(2^5);
        n(96,1) = (-1)*(xor(f(1,34),f(1,41)))*(2^6);
        n(97,1) = (-1)*(f(1,35)&f(1,42))*(2^6);
        n(98,1) = (-1)*(f(1,35)&f(1,42))*(2^7);
        n(99,1) = (-1)*(f(1,35)|f(1,42))*(2^6);
        n(100,1) = (-1)*(f(1,35)|f(1,42))*(2^7);
        n(101,1) = (-1)*(xor(f(1,35),f(1,42)))*(2^6);
        n(102,1) = (-1)*(xor(f(1,35),f(1,42)))*(2^7);
        n(103,1) = (-1)*(f(1,36)&f(1,43))*(2^7);
        n(104,1) = (-1)*(f(1,36)&f(1,43))*(2^8);
        n(105,1) = (-1)*(f(1,36)|f(1,43))*(2^7);
        n(106,1) = (-1)*(f(1,36)|f(1,43))*(2^8);
        n(107,1) = (-1)*(xor(f(1,36),f(1,43)))*(2^7);
        n(108,1) = (-1)*(xor(f(1,36),f(1,43)))*(2^8);
        n(109,1) = (-1)*(f(1,37)&f(1,44))*(2^8);
        n(110,1) = (-1)*(f(1,37)&f(1,44))*(2^9);
        n(111,1) = (-1)*(f(1,37)|f(1,44))*(2^8);
        n(112,1) = (-1)*(f(1,37)|f(1,44))*(2^9);
        n(113,1) = (-1)*(xor(f(1,37),f(1,44)))*(2^8);
        n(114,1) = (-1)*(xor(f(1,37),f(1,44)))*(2^9);
        n(115,1) = (-1)*(f(1,38)&f(1,45))*(2^9);
        n(116,1) = (-1)*(f(1,38)&f(1,45))*(2^10);
        n(117,1) = (-1)*(f(1,38)|f(1,45))*(2^9);
        n(118,1) = (-1)*(f(1,38)|f(1,45))*(2^10);
        n(119,1) = (-1)*(xor(f(1,38),f(1,45)))*(2^9);
        n(120,1) = (-1)*(xor(f(1,38),f(1,45)))*(2^10);
        n(121,1) = (-1)*(f(1,39)&f(1,46))*(2^10);
        n(122,1) = (-1)*(f(1,39)&f(1,46))*(2^11);
        n(123,1) = (-1)*(f(1,39)|f(1,46))*(2^10);
        n(124,1) = (-1)*(f(1,39)|f(1,46))*(2^11);
        n(125,1) = (-1)*(xor(f(1,39),f(1,46)))*(2^10);
        n(126,1) = (-1)*(xor(f(1,39),f(1,46)))*(2^11);
        n(127,1) = (-1)*(f(1,40)&f(1,47))*(2^11);
        n(128,1) = (-1)*(f(1,40)&f(1,47))*(2^12);
        n(129,1) = (-1)*(f(1,40)|f(1,47))*(2^11);
        n(130,1) = (-1)*(f(1,40)|f(1,47))*(2^12);
        n(131,1) = (-1)*(xor(f(1,40),f(1,47)))*(2^11);
        n(132,1) = (-1)*(xor(f(1,40),f(1,47)))*(2^12);
        n(133,1) = (-1)*f(1,48)*(2^12);

        
        n = n * ((pf(1, idx+1) / total_pf )^(0.5)) * ( (pw(1, jdx+1)/ total_pw )^(0.5)); % unsigned mul
        % n = n * ((pf(1, idx + 2^bitN + 1) / total_pf )^(0.5)) * ((pw(1, idx + 2^bitN + 1) / total_pw )^(0.5)); % signed mul

        %%%%%%%%%%%%%%% swap pf and pw %%%%%%%%%%%%

        a = n * n.';
        b = b + a;
        
    end
end


b_test = b;
[r, c] = size(b_test);
for idx = 1:r
    for jdx = 1:c
        if idx < jdx
            b_test(idx, jdx) = b_test(idx, jdx) + b_test(jdx, idx);
        elseif jdx < idx
            b_test(idx, jdx) = 0;
        end
    end
end


b_str = string(b_test);
for jdx = 2:c
    eval(['b_str(1, jdx) = strcat(b_str(1, jdx), ', '"*x(', num2str(jdx-1), ')")', ';']);
end
for idx = 2:r
    for jdx = 2:c
        if idx <= jdx
            eval(['b_str(idx, jdx) = strcat(b_str(idx, jdx), ', '"*x(', num2str(idx-1), ')*x(', num2str(jdx-1), ')")', ';']);
        end
    end
end


b_sym = str2sym(b_str);
objective_function = string(sum(sum(b_sym)));


fid=fopen("objective_function.txt", "w");
fprintf(fid,'%s\n',objective_function);
fclose(fid);


disp("ok");